unit ShowAll;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, GlobalData, ConstData,
  Vcl.StdCtrls, Vcl.ComCtrls;

type
  TForm5 = class(TForm)
    PaintBox1: TPaintBox;
    ListViewGarden: TListView;
    Label1: TLabel;
    Button1: TButton;
    Panel1: TPanel;
    Label2: TLabel;
    ListViewCulture: TListView;
    procedure CreateListViewGarden(list: PtGarden);
    procedure PaintRect(const x, y: integer; const color: Tcolor;
      const brush: Tcolor);
    procedure PaintBox1Paint(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure ListViewGardenClick(Sender: TObject);
    procedure PrintSelectedGarden(const idGarden: integer);
    procedure Button1Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure CreateListViewCulture(const idGarden: integer);
    procedure PaintBox1MouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; x, y: integer);
  private
    { Private declarations }
  public
    function FormShowAll: TModalResult;
    { Public declarations }
  end;

var
  Form5: TForm5;

const
  SizeRect = 20;
  SizePen = 2;
  // BrightenColor(цвет,процент яркости) :TColor;

implementation

{$R *.dfm}

procedure TForm5.PrintSelectedGarden(const idGarden: integer);
begin
  PaintBox1.Canvas.brush.color := clBtnFace;
  PaintBox1.Canvas.FillRect(PaintBox1.ClientRect);

  for var i := 0 to _GardenX do
  begin
    for var j := 0 to _GardenY do
    begin
      if GardenMas[i][j].CodGarden = idGarden then
      begin
        PaintRect(i, j, IdentifyColor(GardenMas[i][j].CodGarden), clSilver);
      end;
    end;
  end;

end;

procedure TForm5.Button1Click(Sender: TObject);
var
  MySet: set of byte;
begin

  for var i := 0 to _GardenX do
  begin
    for var j := 0 to _GardenY do
    begin
      PaintRect(i, j, IdentifyColor(GardenMas[i][j].CodGarden), clSilver);
      Include(MySet, GardenMas[i][j].CodGarden);
    end;
  end;

  ListViewCulture.Clear;
  for var item in MySet do
  begin
    CreateListViewCulture(item);
  end;

end;

procedure TForm5.CreateListViewCulture(const idGarden: integer);
var
  ListItem: TListItem;
begin
  for var i := 0 to _GardenX do
  begin
    for var j := 0 to _GardenY do
    begin
      if GardenMas[i][j].CodGarden = idGarden then
      begin
        ListItem := ListViewCulture.Items.Add;
        ListItem.Caption := GardenMas[i][j].Сulture.Name;
      end;

      // PaintRect(i, j, IdentifyColor(GardenMas[i][j].CodGarden), clSilver);
    end;
  end;

end;

procedure TForm5.CreateListViewGarden(list: PtGarden);
var
  ListItem: TListItem;
  strColor: string;
begin
  ListViewGarden.Clear;

  list := list.Next;
  while list <> nil do
  begin
    ListItem := ListViewGarden.Items.Add;
    ListItem.Caption := list.garden.Name;
    strColor := ColorToString(IdentifyColor(list.garden.CodGarden));
    ListItem.SubItems.Add(Copy(strColor, 3, Length(strColor)));

    list := list.Next;
  end;

end;

procedure TForm5.FormCreate(Sender: TObject);
var
  Column: TListColumn;
  x: integer;
begin

  Column := ListViewGarden.Columns.Add;
  Column.Caption := 'Грядка';
  Column := ListViewGarden.Columns.Add;
  Column.Caption := 'Цвет';
  ListViewGarden.Columns[0].Width := 150;
  ListViewGarden.Columns[1].Width := 150;

  Column := ListViewCulture.Columns.Add;
  Column.Caption := 'Культура';
  ListViewCulture.Columns[0].Width := 160;

  Panel1.color := clCream;

  PaintBox1.Width := _GardenX * SizeRect;
  PaintBox1.Height := _GardenY * SizeRect;

  Panel1.Width := PaintBox1.Width + 2 * 7;
  Panel1.Height := PaintBox1.Height + 2 * 7;

  // Panel1.Left := ClientWidth - Panel1.Width;
  // Panel1.Top := 0;

  PaintBox1.Left := 7;
  PaintBox1.Top := 7;
end;

procedure TForm5.FormShow(Sender: TObject);
begin
  ListViewCulture.Clear;
  ListViewGarden.Clear;

  CreateListViewGarden(Gardenlist);
end;

function TForm5.FormShowAll: TModalResult;
begin
  result := ShowModal;
end;

procedure TForm5.ListViewGardenClick(Sender: TObject);
var
  SelectedItem: TListItem;
begin
  SelectedItem := ListViewGarden.Selected;
  if SelectedItem <> nil then
  begin
    if Assigned(SelectedItem) then
    begin
      PrintSelectedGarden(getIdGarden(SelectedItem.Caption));
    end;

    ListViewCulture.Clear;
    CreateListViewCulture(getIdGarden(SelectedItem.Caption));
  end;
end;

procedure TForm5.PaintRect(const x, y: integer; const color: Tcolor;
  const brush: Tcolor);
var
  tempColor: Tcolor;
  tempBrush: Tcolor;

  Rect: TRect;
begin
  tempBrush := PaintBox1.Canvas.brush.color;
  tempColor := PaintBox1.Canvas.Pen.color;

  PaintBox1.Canvas.brush.color := brush;
  PaintBox1.Canvas.Pen.color := color;
  PaintBox1.Canvas.brush.color := color;

  Rect.CREATE(x * SizeRect + SizePen, y * SizeRect + SizePen,
    (x + 1) * SizeRect, (y + 1) * SizeRect);
  PaintBox1.Canvas.Rectangle(Rect);

  PaintBox1.Canvas.brush.color := tempBrush;
  PaintBox1.Canvas.Pen.color := tempColor;
end;

procedure TForm5.PaintBox1MouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; x, y: integer);
var
  idGarden: integer;
begin
  idGarden := GardenMas[x div SizeRect][y div SizeRect].CodGarden;

  PrintSelectedGarden(idGarden);
  ListViewCulture.Clear;

  CreateListViewCulture(idGarden);
end;

procedure TForm5.PaintBox1Paint(Sender: TObject);
begin
  PaintBox1.Canvas.brush.color := clBtnFace;
  PaintBox1.Canvas.FillRect(PaintBox1.ClientRect);

  for var i := 0 to _GardenX do
  begin
    for var j := 0 to _GardenY do
    begin
      PaintRect(i, j, IdentifyColor(GardenMas[i][j].CodGarden), clSilver);
    end;
  end;
end;

end.
